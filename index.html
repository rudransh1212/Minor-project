<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-based Groundwater Salinity Dashboard</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js for the interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Plotly.js for charts -->
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>

    <!-- React and Babel for running the application in the browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* A little custom CSS to ensure full height */
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevents scrollbars on the main page */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { createRoot } = ReactDOM;

        // --- Helper Components & SVGs ---
        // Using inline SVGs to avoid external dependencies for icons
        const MapIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
        );

        const LineChartIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2">
                <path d="M3 3v18h18"></path>
                <path d="m19 9-5 5-4-4-3 3"></path>
            </svg>
        );

        const BarChartIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2">
                <line x1="12" x2="12" y1="20" y2="10" />
                <line x1="18" x2="18" y1="20" y2="4" />
                <line x1="6" x2="6" y1="20"y2="16" />
            </svg>
        );

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center h-full w-full bg-gray-900 bg-opacity-50 absolute top-0 left-0 z-50">
                <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"></div>
            </div>
        );

        // --- Mock Data Generation ---
        // This section simulates the API backend described in the PRD.
        const indianDistricts = {
            "type": "FeatureCollection",
            "features": [
                {"type": "Feature", "properties": {"name": "North Delhi"}, "geometry": {"type": "Point", "coordinates": [77.15, 28.75]}},
                {"type": "Feature", "properties": {"name": "Mumbai"}, "geometry": {"type": "Point", "coordinates": [72.87, 19.07]}},
                {"type": "Feature", "properties": {"name": "Kolkata"}, "geometry": {"type": "Point", "coordinates": [88.36, 22.57]}},
                {"type": "Feature", "properties": {"name": "Chennai"}, "geometry": {"type": "Point", "coordinates": [80.27, 13.08]}},
                {"type": "Feature", "properties": {"name": "Jaipur"}, "geometry": {"type": "Point", "coordinates": [75.78, 26.91]}},
                {"type": "Feature", "properties": {"name": "Lucknow"}, "geometry": {"type": "Point", "coordinates": [80.94, 26.84]}},
                {"type": "Feature", "properties": {"name": "Bhopal"}, "geometry": {"type": "Point", "coordinates": [77.41, 23.25]}},
                {"type": "Feature", "properties": {"name": "Patna"}, "geometry": {"type": "Point", "coordinates": [85.13, 25.59]}},
                {"type": "Feature", "properties": {"name": "Ahmedabad"}, "geometry": {"type": "Point", "coordinates": [72.57, 23.02]}},
                {"type": "Feature", "properties": {"name": "Hyderabad"}, "geometry": {"type": "Point", "coordinates": [78.48, 17.38]}},
                {"type": "Feature", "properties": {"name": "Bengaluru"}, "geometry": {"type": "Point", "coordinates": [77.59, 12.97]}},
                {"type": "Feature", "properties": {"name": "Nagpur"}, "geometry": {"type": "Point", "coordinates": [79.08, 21.14]}},
            ]
        };

        const getMockMapData = () => new Promise(resolve => {
            setTimeout(() => {
                const data = indianDistricts.features.map(feature => ({
                    name: feature.properties.name,
                    lat: feature.geometry.coordinates[1],
                    lng: feature.geometry.coordinates[0],
                    salinity: (Math.random() * 3.5 + 0.5).toFixed(2), // Random salinity in dS/m
                }));
                resolve(data);
            }, 800);
        });

        const getMockTimeSeriesData = (district, scenario) => new Promise(resolve => {
            setTimeout(() => {
                const baseSalinity = 1.5 + Math.random();
                const historical = Array.from({ length: 24 }, (_, i) => ({
                    year: 2000 + i,
                    salinity: baseSalinity + (Math.random() - 0.5) * 0.4
                }));

                const multiplier = scenario === 'rcp45' ? 1.05 : 1.15;
                let lastSalinity = historical[historical.length - 1].salinity;
                
                const future = Array.from({ length: 26 }, (_, i) => {
                    lastSalinity *= (1 + (Math.random() * 0.05 * multiplier));
                    return {
                        year: 2025 + i,
                        salinity: lastSalinity,
                        ci_low: lastSalinity * 0.9,
                        ci_high: lastSalinity * 1.1,
                    };
                });

                resolve({
                    district,
                    historical,
                    predictions: future
                });
            }, 1200);
        });

        const getMockFeatureImportanceData = (district) => new Promise(resolve => {
            setTimeout(() => {
                const features = [
                    'Rainfall', 'Temperature', 'Evapotranspiration', 
                    'Soil Texture', 'Land Use', 'Proximity to Coast'
                ];
                const importance = features.map(feature => ({
                    feature,
                    shap_value: Math.random() * 0.5
                })).sort((a, b) => b.shap_value - a.shap_value);
                resolve({ district, importance });
            }, 1000);
        });


        // --- Map Component ---
        const MapVisualization = ({ mapData, onDistrictSelect, selectedDistrict }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef([]);

            useEffect(() => {
                if (!mapRef.current) return;

                // Initialize map only once
                if (!mapInstance.current) {
                    mapInstance.current = L.map(mapRef.current).setView([22.5937, 78.9629], 5); // Centered on India
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                    }).addTo(mapInstance.current);
                }

                // Clear existing markers
                markersRef.current.forEach(marker => marker.remove());
                markersRef.current = [];

                // Add new markers
                if (mapData.length > 0) {
                    mapData.forEach(data => {
                        const color = getSalinityColor(data.salinity);
                        const marker = L.circleMarker([data.lat, data.lng], {
                            radius: 8,
                            fillColor: color,
                            color: '#fff',
                            weight: 1.5,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(mapInstance.current);

                        marker.bindTooltip(`<b>${data.name}</b><br>Salinity: ${data.salinity} dS/m`);
                        marker.on('click', () => {
                            onDistrictSelect(data.name);
                            mapInstance.current.setView([data.lat, data.lng], 8);
                        });

                        markersRef.current.push(marker);
                    });
                }
            }, [mapData, onDistrictSelect]);
            
            // Highlight selected district
             useEffect(() => {
                markersRef.current.forEach(marker => {
                    const isSelected = marker.getTooltip().getContent().includes(`<b>${selectedDistrict}</b>`);
                    marker.setStyle({
                        weight: isSelected ? 3 : 1.5,
                        color: isSelected ? '#38bdf8' : '#fff', 
                    });
                    if (isSelected) {
                        marker.bringToFront();
                    }
                });
            }, [selectedDistrict]);

            return <div ref={mapRef} className="h-full w-full rounded-lg shadow-xl" />;
        };


        // --- Chart Components ---
        const TimeSeriesChart = ({ data, scenario }) => {
            const chartRef = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !data) return;

                const historicalTrace = {
                    x: data.historical.map(d => d.year),
                    y: data.historical.map(d => d.salinity),
                    mode: 'lines+markers',
                    name: 'Historical',
                    line: { color: '#9ca3af' },
                    marker: { size: 4 }
                };

                const predictionTrace = {
                    x: data.predictions.map(d => d.year),
                    y: data.predictions.map(d => d.salinity),
                    mode: 'lines',
                    name: `Prediction (${scenario.toUpperCase()})`,
                    line: { color: '#2dd4bf', dash: 'dash' }
                };

                const ciTraceUpper = {
                    x: data.predictions.map(d => d.year),
                    y: data.predictions.map(d => d.ci_high),
                    mode: 'lines',
                    name: 'Upper CI',
                    line: { width: 0 },
                    showlegend: false,
                };
                
                const ciTraceLower = {
                    x: data.predictions.map(d => d.year),
                    y: data.predictions.map(d => d.ci_low),
                    mode: 'lines',
                    name: 'Confidence Interval',
                    line: { width: 0 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(45, 212, 191, 0.2)',
                };


                const layout = {
                    title: {
                        text: `Groundwater Salinity Trend: ${data.district}`,
                        font: { color: '#e5e7eb', size: 16 },
                        x: 0.05,
                        xanchor: 'left',
                    },
                    xaxis: {
                        title: 'Year',
                        gridcolor: '#4b5563',
                        linecolor: '#6b7280',
                        tickfont: { color: '#d1d5db' }
                    },
                    yaxis: {
                        title: 'Salinity (dS/m)',
                        gridcolor: '#4b5563',
                        linecolor: '#6b7280',
                        tickfont: { color: '#d1d5db' }
                    },
                    plot_bgcolor: '#1f2937',
                    paper_bgcolor: '#1f2937',
                    legend: {
                        font: { color: '#d1d5db' },
                        x: 0.98,
                        xanchor: 'right',
                        y: 0.98,
                        yanchor: 'top'
                    },
                    margin: { l: 50, r: 20, t: 50, b: 50 },
                };
                
                Plotly.newPlot(chartRef.current, [historicalTrace, ciTraceUpper, ciTraceLower, predictionTrace], layout, {responsive: true});

            }, [data, scenario]);

            if (!data) return null;
            return <div ref={chartRef} className="h-full w-full"></div>;
        };

        const FeatureImportanceChart = ({ data }) => {
            const chartRef = useRef(null);
            useEffect(() => {
                if (!chartRef.current || !data) return;
                
                const sortedData = [...data.importance].reverse();

                const trace = {
                    x: sortedData.map(d => d.shap_value),
                    y: sortedData.map(d => d.feature),
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: '#38bdf8'
                    }
                };

                const layout = {
                    title: {
                        text: `Key Drivers of Salinity: ${data.district}`,
                        font: { color: '#e5e7eb', size: 16 },
                         x: 0.05,
                        xanchor: 'left',
                    },
                    xaxis: {
                        title: 'Mean SHAP Value (Impact on Model Output)',
                        gridcolor: '#4b5563',
                        linecolor: '#6b7280',
                        tickfont: { color: '#d1d5db' }
                    },
                    yaxis: {
                        automargin: true,
                        tickfont: { color: '#d1d5db' }
                    },
                    plot_bgcolor: '#1f2937',
                    paper_bgcolor: '#1f2937',
                    margin: { l: 120, r: 20, t: 50, b: 50 }
                };

                Plotly.newPlot(chartRef.current, [trace], layout, {responsive: true});
            }, [data]);
            
            if (!data) return null;
            return <div ref={chartRef} className="h-full w-full"></div>;
        };

        const getSalinityColor = (salinity) => {
            if (salinity < 1.0) return '#5eead4'; // Low - Teal
            if (salinity < 2.0) return '#6366f1'; // Moderate - Indigo
            if (salinity < 3.0) return '#facc15'; // High - Yellow
            return '#ef4444'; // Very High - Red
        };

        // --- Main App Component ---
        function App() {
            const [mapData, setMapData] = useState([]);
            const [selectedDistrict, setSelectedDistrict] = useState(null);
            const [scenario, setScenario] = useState('rcp45');
            const [timeSeriesData, setTimeSeriesData] = useState(null);
            const [featureImportanceData, setFeatureImportanceData] = useState(null);
            const [loading, setLoading] = useState({ map: true, details: false });

            useEffect(() => {
                setLoading(prev => ({ ...prev, map: true }));
                getMockMapData().then(data => {
                    setMapData(data);
                    // Select a default district on load
                    if (data.length > 0) {
                        handleDistrictSelect(data[0].name);
                    }
                    setLoading(prev => ({ ...prev, map: false }));
                });
            }, []); // Empty dependency array means this runs once on mount

            const handleDistrictSelect = useCallback((district) => {
                setSelectedDistrict(district);
                setLoading(prev => ({ ...prev, details: true }));
                
                const timeSeriesPromise = getMockTimeSeriesData(district, scenario);
                const featureImportancePromise = getMockFeatureImportanceData(district);

                Promise.all([timeSeriesPromise, featureImportancePromise]).then(([tsData, fiData]) => {
                    setTimeSeriesData(tsData);
                    setFeatureImportanceData(fiData);
                    setLoading(prev => ({ ...prev, details: false }));
                });
            }, [scenario]);

            useEffect(() => {
                if (selectedDistrict) {
                    setLoading(prev => ({ ...prev, details: true }));
                    getMockTimeSeriesData(selectedDistrict, scenario).then(tsData => {
                        setTimeSeriesData(tsData);
                        setLoading(prev => ({ ...prev, details: false }));
                    });
                }
            }, [scenario, selectedDistrict]);
            
            const Legend = () => (
                <div className="absolute bottom-4 right-4 bg-gray-800 bg-opacity-80 p-3 rounded-lg text-white text-sm shadow-lg z-[1000]">
                    <h4 className="font-bold mb-2">Salinity (dS/m)</h4>
                    <div className="flex items-center mb-1"><div className="w-4 h-4 rounded-full mr-2" style={{backgroundColor: getSalinityColor(0.5)}}></div>{'< 1.0 (Low)'}</div>
                    <div className="flex items-center mb-1"><div className="w-4 h-4 rounded-full mr-2" style={{backgroundColor: getSalinityColor(1.5)}}></div>{'1.0 - 2.0 (Mod.)'}</div>
                    <div className="flex items-center mb-1"><div className="w-4 h-4 rounded-full mr-2" style={{backgroundColor: getSalinityColor(2.5)}}></div>{'2.0 - 3.0 (High)'}</div>
                    <div className="flex items-center"><div className="w-4 h-4 rounded-full mr-2" style={{backgroundColor: getSalinityColor(3.5)}}></div>{'> 3.0 (V. High)'}</div>
                </div>
            );

            return (
                <div className="flex h-screen bg-gray-900 text-gray-200 font-sans">
                    {/* Sidebar */}
                    <aside className="w-80 bg-gray-800 p-6 flex flex-col space-y-6 shadow-2xl">
                        <div>
                            <h1 className="text-2xl font-bold text-white">Groundwater Salinity</h1>
                            <p className="text-sm text-cyan-400">Mapping & Prediction for India</p>
                        </div>

                        <div className="flex-grow flex flex-col space-y-8">
                             {/* Climate Scenario Selector */}
                            <div>
                                <h2 className="text-lg font-semibold mb-3">Climate Scenario</h2>
                                <div className="flex flex-col space-y-2">
                                    <label className={`flex items-center p-3 rounded-lg cursor-pointer transition-all ${scenario === 'rcp45' ? 'bg-cyan-500 text-white shadow-lg' : 'bg-gray-700 hover:bg-gray-600'}`}>
                                        <input type="radio" name="scenario" value="rcp45" checked={scenario === 'rcp45'} onChange={(e) => setScenario(e.target.value)} className="hidden" />
                                        <span className="font-bold">RCP 4.5</span>
                                        <span className="ml-auto text-xs">Moderate</span>
                                    </label>
                                    <label className={`flex items-center p-3 rounded-lg cursor-pointer transition-all ${scenario === 'rcp85' ? 'bg-cyan-500 text-white shadow-lg' : 'bg-gray-700 hover:bg-gray-600'}`}>
                                        <input type="radio" name="scenario" value="rcp85" checked={scenario === 'rcp85'} onChange={(e) => setScenario(e.target.value)} className="hidden" />
                                        <span className="font-bold">RCP 8.5</span>
                                        <span className="ml-auto text-xs">High Emission</span>
                                    </label>
                                </div>
                            </div>
                            
                            {/* Selected District Info */}
                            <div>
                                 <h2 className="text-lg font-semibold mb-3">Selection Details</h2>
                                 <div className="bg-gray-700 p-4 rounded-lg min-h-[100px]">
                                    {selectedDistrict ? (
                                        <div>
                                            <h3 className="font-bold text-cyan-400 text-xl">{selectedDistrict}</h3>
                                            <p className="text-sm text-gray-400 mt-1">
                                                Displaying analysis for the selected district. Change climate scenario to see different predictions.
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="text-gray-400 text-center py-4">
                                            <p>Click on a district on the map to view detailed analysis.</p>
                                        </div>
                                    )}
                                 </div>
                            </div>
                        </div>

                        <div className="text-xs text-gray-500 text-center">
                            <p>A policy implementation tool for sustainable water resource management.</p>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-6 flex flex-col space-y-6">
                        <div className="flex-1 bg-gray-800 rounded-lg shadow-inner relative">
                            {loading.map && <LoadingSpinner />}
                            <MapVisualization mapData={mapData} onDistrictSelect={handleDistrictSelect} selectedDistrict={selectedDistrict} />
                            <Legend />
                        </div>
                        <div className="h-96 flex space-x-6">
                            <div className="w-1/2 bg-gray-800 p-4 rounded-lg shadow-inner relative flex items-center justify-center">
                                 <div className="absolute top-4 left-4 flex items-center text-gray-400 text-sm"><LineChartIcon/> Time Series Forecast (2000-2050)</div>
                                 {loading.details && <LoadingSpinner />}
                                 {!selectedDistrict && !loading.details && <p className="text-gray-500">Select a district to see time series data.</p>}
                                 {selectedDistrict && !loading.details && <TimeSeriesChart data={timeSeriesData} scenario={scenario} />}
                            </div>
                            <div className="w-1/2 bg-gray-800 p-4 rounded-lg shadow-inner relative flex items-center justify-center">
                                <div className="absolute top-4 left-4 flex items-center text-gray-400 text-sm"><BarChartIcon/> Salinity Driver Analysis (XAI)</div>
                                {loading.details && <LoadingSpinner />}
                                {!selectedDistrict && !loading.details && <p className="text-gray-500">Select a district to see feature importance.</p>}
                                {selectedDistrict && !loading.details && <FeatureImportanceChart data={featureImportanceData} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
